# 駭客實務入門_15_規避入侵偵測防火牆和誘捕系統
## 🗡入侵偵測 IDS
入侵偵測(Intrusion Detection System，IDS)：是指通過對網路行為、LOG或稽核資料或其他網路上可以獲得的資訊，從資料庫中比對入侵系統的異常行為或入侵特徵，==不主動阻斷攻擊行為，屬於被動防禦==

### 觸發方式
- 特徵觸發：==比對已知的特徵資料庫==中的封包資料、攻擊特徵、大量的不應出現傳輸資料，像是惡意程式會直接走HTTP或HTTPS來混雜在正常流量中，並且會切割成好幾次存取
- 未曾使用的觸發：在特徵觸發中以外的，這種流量通常無法和已知的資料庫比對且夾雜在正常流量中
- 異常協定觸發：惡意程式所使用的協定，像是[Metasploit](https://www.metasploit.com/)預設使用的4444 port
- 檔案系統觸發：
	1. 異常的檔案新增或寫入不正常的路徑
	2. 攻擊者入侵系統後會利用存取管理者權限或是利用弱點提升權限
	3. 紀錄檔案大小異常增加或減少，可能是大量攻擊行為産生的Log或是攻擊者清理軌跡
	4. 執行檔案多了SGID或是SUID等特權權限
- 網路觸發：
	1. 頻寬流量突然增加
	2. 重複連線服務的行為
	3. 未經允許的連線行為
	4. 重複登入
	5. 短時間內大量的連線紀錄，像是DoS、DDos、頻寬被耗盡
- 系統觸發：
	1. 突然改變的系統紀錄
	2. 系統突然變慢
	3. 系統紀錄消失或是紀錄權限改變
	4. 檔案或軟體設定遭竄改
	5. 異常的圖片顯示或文字顯示
	6. 系統當機或重開
	7. 不常見的的程式正在執行

### IDS型態
- Networked-Based 網路型態
	1. 側錄所有封包
	2. 以分析網路封包為主
	3. 事前預警
- Host-Based 主機型態
	1. 以收集主機的紀錄為主
	2. 較容易偵測到未經允許的行為
- 注意：IDS可能存在誤報的情況
- IDS 告警型態
	- True，判斷正確，也就是攻擊發生
	- False，判斷失敗，也就是攻擊沒發生
	- Positive，有告警
	- Negative，無告警

| Type               | Description                        |
| ------------------ | ---------------------------------- |
| True Positive(++)  | 有實際攻擊且觸發告警               |
| False Positive(-+) | 沒有實際攻擊但觸發告警(相當於雜訊) | 
| False Negative(--) | 有攻擊但沒有觸發告警(表示規則無效) |
| True Negative(-+)  | 沒有攻擊也沒有觸發告警             |

## 🗡入侵預防系統 IPS
- 入侵預防系統（Intrusion Prevention System，IPS），是為了彌補防毒軟體和防火牆的不足。入侵預防系統的功能主要是監視網路的行為，與IDS的差別是能夠即時的中斷不正常或是具有攻擊性的的網路行為，屬於主動防禦
- 入侵預防技術
	1. 在遇到動態程式碼等各種指令語言時，先把它們放在沙箱內，觀察行為，如果發現有可疑情況，則停止傳輸，禁止執行
	2. 入侵預防系統結合協定異常、傳輸異常和特徵偵查，對通過閘道器或防火牆進入網路內部的有害程式碼實行有效阻止
- 入侵預防系統類型
	1. 主機入侵預防系統(HIPS: Host based Intrusion Prevention System)
	2. 網路入侵預防系統(NIPS: Network Intrusion Prevention System)

## 🗡周邊網路 Perimeter Network
- 邊界網路(Perimeter Network)或稱非軍事區(Demilitarized Zone)為一種網路架構的方式，常用在不信任的外部網路和可信任的內部網路之間，建立一個面向外部的子網路，該子網路內者主要架設給外部使用者使用的伺服器
- 一般而言，DMZ區會有以下特點
	1. 提供服務給外界存取
	2. 網段須與內網隔開
	3. DMZ 內的伺服器並不會包含任何機密資料

![駭客實務入門_15_規避入侵偵測防火牆和誘捕系統_01_周邊網路](https://github.com/MickeyHuang233/CodingStudyNote/blob/main/05_%E8%B3%87%E5%AE%89%E6%8A%80%E8%A1%93/%F0%9F%97%A1%E9%A7%AD%E5%AE%A2%E5%AF%A6%E5%8B%99%E5%85%A5%E9%96%80/images/%E9%A7%AD%E5%AE%A2%E5%AF%A6%E5%8B%99%E5%85%A5%E9%96%80_15_%E8%A6%8F%E9%81%BF%E5%85%A5%E4%BE%B5%E5%81%B5%E6%B8%AC%E9%98%B2%E7%81%AB%E7%89%86%E5%92%8C%E8%AA%98%E6%8D%95%E7%B3%BB%E7%B5%B1_01_%E5%91%A8%E9%82%8A%E7%B6%B2%E8%B7%AF.png?raw=true)

## 🗡防火牆 Firewall
- 架設防火牆，就是在企業內部網路及網際網路之間架設一道可監控管理的緩衝界面，管制所有網路封包的進出，允許或禁止網路上特定之資料存取行為
- 防火牆主要工作就是檢查所有通過的封包，藉由 IP 位址、協定的傳送方向來控制網路封包的傳輸。每個組織都需要根據實際網路運作需求，在網路的使用與安全之間做取捨，制定企業最佳網路安全政策

### 各OSI層的防火牆技術 
| OSI層      | 防火牆技術                    |
| ---------- | ----------------------------- |
| 應用層     | VPN、代理伺服器               |
| 表達層     | VPN                           |
| 會議層     | VPN、電路層防火牆             |
| 傳輸層     | VPN、封包過濾                 |
| 網路層     | 封包過濾、NAT、狀態檢視防火牆 |
| 資料鏈接層 | 封包過濾                      |
| 實體層     | 無                            |

- 封包過濾(Packet Filtering)：這種防火牆會檢查封包標頭的接收端和發送端IP位址、封包類型、埠號和其他網路資訊，並允許符合規則的封包通過，但不會檢查封包內的資料內容
- 電路閘道(Circuit-Level Gateways)：
	1. 電路閘道器不需要大量的運算能力和資源，它的作用與封包過濾防火牆一樣，閘道器不會檢查封包內的資料內容，只檢查封包來源。
	2. 為了讓封包通過，電路閘道器會檢查封包是否為TCP認可的合法來源，不過這種作法無法保證安全性，因為即使封包來源是安全的，惡意程式仍可能隱藏在封包中
- 狀態檢視防火牆(Stateful Multilayer Inspection)
	1. 狀態檢查防火牆同時具有封包過濾防火牆、電路閘道器的作用，它經由過濾封包和檢查封包來源，並持續追蹤穿過防火牆的各種連線的狀態
	2. 但因為狀態檢查防火牆執行較多的處理，因此效能比封包過濾防火牆較差
- 應用層防火牆(Application-Level Firewall)
	1. 應用層防火牆也稱為代理防火牆，它會檢查內部網路和流量來源之間的流量
	2. 它先經由代理伺服器傳遞流量，並檢查傳入的流量，然後才允許流量進入內部網路中。應用層防火牆有點類似狀態檢查，會同時檢查封包和 TCP 握手。兩者之間的主要差異是，狀態檢查防火牆只會檢查封包來源，應用層防火牆則會檢查封包內容，並進行深度封包檢查(DPI)
	3. 應用層防火牆還能將內部網路與流量來源分離，為網路提供一層匿名性和額外的保護。不過檢查封包需要花費較多的時間，因此可能會造成連線速度變慢
- 虛擬私人網路(Virtual Address Network，VPN)
	1. VPN是常用於連接中、大型企業或團體間私人網路的通訊方法
	2. 它利用隧道協定(Tunneling Protocol來達到傳送端認證、訊息保密與準確性等功能

## 🗡誘捕系統 Honeypot System
- 誘捕系統(Honeypot)設計目的是為了==讓攻擊者入侵一個假的系統==，主要用於觀察網路於被入侵的同時進行觀察、紀錄，如此一來，便可攻擊行為追蹤或是發現新型的攻擊模式
- 從防禦的角度來看，把誘捕系統與真實主機放在一起時，==會增加攻擊者探測系統主機的時間成本==，進而增加管理員的應變時間
- 另一方面，攻擊者在進行攻擊行動前，通常會先做掃描動作，用以尋找弱點主機，以此作為攻擊起點，==誘捕系統可針對掃描做紀錄外，同時，也是另一種的預警系統==，使得管理者可以即早發現並做出反應
- ==誘捕系統不同於其他入侵偵測系統，可能會產生誤報的情況==，主要原因在於，誘捕系統並非一般使用者會使用的系統，因為所有進入誘捕系統的連線，都有攻擊行為的嫌疑
- 可以通過Shodan查詢Honeypot的設備，並盡可能避免攻擊它們，但也有可能系統管理者會在Shodan標上Honeypot的標籤

### 誘捕系統型態
#### 低互動誘捕系統
此類誘捕系統以模擬一般的系統和服務來，攻擊者無法在此類誘捕系統上執行任何程式，因此獲取的攻擊者的資訊會較少且不夠詳細

#### 中互動誘捕系統
同樣是以誘捕系統模擬系統的服務，但允許攻擊者執行部分程式，與低互動誘捕系統相比面臨的資訊風顯較大，但可以獲得較多攻擊者資訊

#### 高互動誘捕系統
是以真正的系統和服務運行，允許攻擊者自由地存取各種資源，獲取的攻擊資訊最為詳細，但所承受的風險為最高

#### 營運型誘捕系統
這種誘捕系統易於佈署，但獲取的攻擊者的資訊有限，主要由公司或組織使用。商業型誘捕系統被放置在營運網路裡與其他伺服器放在一起一起，以改善整體網路安全政策，主要用於預防

#### 研究型誘捕系統
這些誘捕系統不會為特定的公司增加商業價值，是為了收集有關不同網路中攻擊者的動機和策略的資訊。這些系統主要用於研究組織面臨的威脅，並學習預防這些威脅。研究型誘捕系統可以捕獲大量資訊，但部署和維護非常複雜

#### 惡意程式型誘捕系統
仿程式和 API 來引誘惡意軟體攻擊，然後可以通過分析惡意程式的特徵，開發防毒軟體的特徵或修補 API 中的弱點，像是有弱點的協定SMBv1

#### 資料庫型誘捕系統
在誘捕系統中搭建有弱點的資料庫應用程式，誘使攻擊者嘗試攻擊，紀錄相關攻擊者的SQL語法，來提升WAF的攔截率

#### 垃圾郵件或電子郵件誘捕系統
將偽造的電子郵件地址放置在網頁中的隱藏位置，只有自動收集的機器人才能可能找到它。由於該地址除自動收集的機器人外，沒有任何其他用途，因此可以100%確定發送到偽造的電子郵件的任何郵件都是垃圾郵件

#### 網路爬蟲程式誘捕系統
此誘捕系統的內容和鏈接只有網路爬蟲才有可能存取的到。檢測網路爬蟲可以幫助了解如何阻止惡意機器人以及惡意廣告網路爬蟲程式

#### 誘捕系統網路
多個誘捕系統見裡的網路，通常這種網路內會大量放置弱點，攻擊者透過這些弱點一一突穿，可以透過這些系統來了解攻擊者的路徑和和可使用的弱點，以制定更完善的防禦策略

## 🗡偵測工具 Snort
- Snort是一套IDS開放原始碼軟體，透過數千條Rule的比對，能夠找出可疑特徵的封包，能提供網路管理人員得知網路惡意攻擊行為的發生，藉此做出適當的防護調整
- 工具官網：[Snort](https://www.snort.org/)

### Snort目錄結構
```bash
/etc/snort
├── barnyard2.conf         barnyard2日志分析工具設定檔
├── snort.conf snort       設定檔
├── threshold.conf         事件過濾設定檔
├── classification.config  規則分類設定檔(classtype)
├── reference.config       外部參考設定檔(reference)
├── gen-msg.map            generate id和msg 對應關係
├── sid-msg.map            snort id和msg對應關係
├── unicode.map            預處理器http_inspect編碼檔
├── preproc_rules          預處理器及解碼器規則集
│ ├── decoder.rules
│ ├── preprocessor.rules
│ └── sensitive-data.rules
├── rules                  Snort規則集
│ ├── local.rules
│ ├── snort.rules
```

### Snort規則
```bash
alert tcp 192.168.1.1 any -> 192.168.1.2 80 (msg:"Web Access"; sid:1; classtype:shellcode-detect; priority:10)
```

- `alert`，表示如果此條規則被觸發，則發出告警
	- `alert`，使用rule中設定的方法警告，並且記錄下來
	- `log`，記錄下來
	- `pass`，略過封包
- `tcp`，協議類型，目前支援TCP、UDP、ICMP、IP
- `192.168.1.1`、`192.168.1.2`，來源/目的IP位址
- `any`、`80`，來源/目的端口，`any`表示任何一個端口
- Snort規則
	1. `msg:"message"`，設定`log`及`alert`動作時顯示的訊息
	2. `sid`，snort規則序號，< 100 系統保留，100～999999 snort使用 ，>=1000,000 本地端使用
	3. `classtype`，規則類別標識，把告警分成不同的攻擊類
	4. `priority`，設定`classtype`的優先順序，高priority被觸發而其他規則不觸發
	5. `content: "<content string>"`，設定要比對的封包，符合的話才會啟動rule。內部可以使用ASCII或HEX。如果是HEX的話需要用`|`括住
	6. `replace: "<replace string>"`，將前一個符合content的字串取代成replace指定的內容

### iptable
| 設定值  | 說明                               |
| ------- | ---------------------------------- |
| drop    | 告訴iptables丟棄封包               |
| sdrop   | 告訴iptables丟棄封包，並且不做紀錄 |
| reject  | 告訴iptables拒絕封包               |
| active  | 如同alert，然後啟動另一條 rule     |
| dynamic | 如同log，但只會由 active 啟動      |

## 🗡入侵偵測系統規避 Intrusion Detection System Evasion
### 插入 inject
攻擊者在請求中夾帶可以讓伺服器解析的URL，但是這串URL卻不被入侵偵測系統所偵測，如：`http://xxx.xx.xxx.xxx/status/:;/admin.php`，因為中間插入了`/:;`IDS 不認識就直接放行，伺服器也成功解析。有點類似[[🗡駭客實務入門_08_網頁伺服器入侵#🗡入侵方式]]中平台解析不一致的狀況

### Dos(Denial of Service)
- Dos攻擊可能會讓偵測系統耗盡資源導致系統直接放行或當機，對外網路中斷，導致後續的攻擊無法偵測，可參考：[[🗡駭客實務入門_14_阻斷服務攻擊]]
- CPU DoS: 加密，封包重組
- Memory DoS: TCP 三項交握封包重組
- Network Bandwidth DoS:頻寬耗盡

### 混淆 Obfuscation
攻擊者將攻擊程式碼進行編碼，讓IDS無法偵測，如：Base64

### 誤報 False Negative
攻擊者將許多容易觸發偵測系統的特徵的封包，大量傳送使系統誤報，並把真正的攻擊夾雜在裡面

### Session 拼接 Session splicing
攻擊者將封包切成較小的封包並將接這封包延遲傳送，讓偵測系統以為是要停止連線，無法檢測到完整的封包，但是在短時間內的Session依然有效，目的端依然會將這些封包重組

### Unicode 繞過 Unicode Bypass
Unicode是業界的一種編碼系統標準，它包含了世界各國的常用文字，使電腦系統得以呈現世界上數十種文字。它為每種語言中的每個字元設定了統一而且唯一的二進位編碼，以滿足跨語言、跨平台進行文本轉換與處理的要求，如：`/?redir=http://google。com�`

### 封包切割 Packet Splitting
攻擊者將封包切割後再相隔數秒的時間發送封包，直到目標系統重新組合所有封包為止

- overlap
	1. 封包 1：GET /cgi-bin/
	2. 封包 2： aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/…/phxx
	3. 封包 3：f?
	4. 結果：GET /cgi-bin/ aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/…/phf?
- overwrite
	1. 封包 1：GET /cgi-bin/
	2. 封包 2：some_xxxxxx_filename.cgi
	3. 封包 3：/aaa/…/aaa/…/aaa/…/phxx
	4. 封包 4：f?
	5. 結果：GET /cgi-bin/phf?

### Time to live
攻擊者必須先了解目標的網路架構，利用修改TTL來欺騙IDS，假定到達目標的TTL必須大於20

1. 封包 1: GET /cgi-bin/p TTL 20
2. 封包 2: somexxxxxx.cgi?= TTL 15，因為TTL必須大於20，所以此封包會被丟掉
3. 封包 3: hf? TTL 20
4. 結果:因為封包2的TTL數不足無法到達目標，但是後續的封包成功繞過IDS，在目標端重新組合成 GET /cgi-bin/phf?

### 多態的程式碼 Polymorphic Shell code
在程式本身就有漏洞的情況下，大多數的Shellcode都會將弱點的程式碼加密以繞過偵測系統使用字串偵測攻擊的程式碼
```console
\x31\xc0\x31\xdb\x31\xc9\x53\x68\x73\x73\x77\x64\x68\x63\x2f\x70\x61\ x68\x2f\x2f\x65\x74\x89\xe3\x66\xb9\x01\x04\xb0\x05\xcd\x80\x89\xc3\x3 1\xc0\x31\xd2\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x68\x3a\x3a\x2f\x 3a\x68\x3a\x30\x3a\x30\x68\x62\x6f\x62\x3a\x89\xe1\xb2\x14\xb0\x04\xc d\x80\x31\xc0\xb0\x06\xcd\x80\x31\xc0\xb0\x01\xcd\x80
```

### ASCII Shell code
利用可識字元的組合方式來繞過偵測系統
```console
wULNRoKJTUMBDp2G3AQIScGJTUaCiU4DxQ6dhs4ACEnBQs1GgolNQwu OnYbcBAhJwYlNRoKJTgPFDp2GzgAIScFCzUaCiU1DxQ6dhtwECEnBiU1CyV /fw==
```

## 🗡防火牆規避 Firewall Evasion
### Port 掃描
識別有啟動的服務和開啟的Port

### Firewalking
- 透過通過發送TCP或UDP封包規避防火牆，這些封包的TTL比目標閘道道多1個TTL
- 如果防火牆允許流量通過，偵測系統將會把封包轉發，因為TTL只多1個所以到期後，會回送 ICMP_TIME_EXCEEDED
- 如果防火牆主機不允許流量，則很可能直接丟棄封包，將不會有任何回應

### Source Routing
選擇路由的路徑，藉以繞過防火牆到達目的端

### Tiny Fragments
強制將某些TCP封包的表頭資訊放入下一個封包

### ICMP Tunneling
由於資料是用 PING 請求/回覆通過網路層傳輸，因此並不需要指定服務或者Port。這種流量是無法在應用層防火牆檢測到的

### Ack Tunneling
攻擊者使用將ACK的BIT設定成需要傳輸的資料設定成ACK BIT後利用TCP封包的方式傳輸出去

### HTTP /HTTPS Tunneling
- 將所有的連線流量利用HTTP/HTTPS的協定傳輸出去
- 一般來說主機或企業的防火牆都會放行HTTP/HTTPS協定